name: Block merge on "do not merge" label or description

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited, ready_for_review]

jobs:
  block-do-not-merge:
    name: Enforce Do Not Merge label
    runs-on: ubuntu-latest

    steps:
      - name: Block if any label name or description includes "do not merge"
        env:
          LABELS_JSON: ${{ toJson(github.event.pull_request.labels) }}
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq
          echo "$LABELS_JSON" | jq -r '.[] | "\(.name):\(.description // "")"' |
          while IFS=: read -r NAME DESC; do
            if echo "$NAME $DESC" | tr '[:upper:]' '[:lower:]' | grep -q 'do not merge'; then
              echo "::error::Blocking merge — '${NAME}' or its description contains 'do not merge'."
              exit 1
            fi
          done
          echo "✅ No blocking labels found."
