name: Enforce Do Not Merge label

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited, ready_for_review]
  push:
    branches: ['*']   # adjust if you only want it on certain branches (e.g. ['main', 'PayBill'])

jobs:
  enforce-on-pr:
    name: Enforce Do Not Merge label
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check labels for 'do not merge'
        env:
          LABELS_JSON: ${{ toJson(github.event.pull_request.labels) }}
        run: |
          # jq already exists on ubuntu-latest
          echo "$LABELS_JSON" | jq -r '.[] | "\(.name):\(.description // "")"' |
          while IFS=: read -r NAME DESC; do
            if echo "$NAME $DESC" | tr '[:upper:]' '[:lower:]' | grep -q 'do not merge'; then
              echo "::error::Blocking merge — '${NAME}' or its description contains 'do not merge'."
              exit 1
            fi
          done
          echo "✅ No blocking labels found."

  noop-on-push:
    name: Enforce Do Not Merge label
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Push event: passing required check"
          exit 0
